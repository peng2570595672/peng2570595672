<wxs src='../../../utils/util.wxs' module='tools' />
<view class="index">
    <!-- 顶部 进度条 组件 -->
    <view class="topSplit">
        <topProgressBar progressStage="{{topProgressBar}}" />
    </view>
    <!-- 套餐模块 -->
    <view class="package" wx:for="{{listOfPackages}}" wx:key="index">
        <view class="module moduleOne iconfont {{'module' + index}} {{index === activeIndex ? 'btnHighLight' : ''}}" data-index="{{index}}" data-shopproductid="{{item.shopProductId}}" catchtap="btnHeightLight">
            <!-- 活动标签 限制字符8个 -->
            <view class="active {{index === activeIndex ? 'activeChange' : ''}}" wx:if="{{item.activeTag}}">
                <text>{{tools.limitNumber(item.activeTag,8)}}</text>
            </view>
            <!-- 默认展示的套餐上半部分 -->
            <view class="upperPart {{ item.productRecommend ? '' : 'subUpperPart'}}" style="background-image: url('{{item.bgImg}}')">
                <!-- 背景logo -->
                <view class="bgImg">
                    <image src="{{item.productLogo}}" />
                </view>
                <view class="titleMOney">
                    <!-- 套餐名称：取后台套餐名称 -->
                    <view class="title">{{tools.limitNumber(item.productName,18)}}</view>
                    <!-- 取后台支付金额，保留小数点后2位，若套餐支付金额为0时，前端价格展示为免费 -->
                    <view class="money">
                        <span wx:if="{{item.pledgePrice || equityListMap.addEquityList[index].subData[equityListMap.addEquityList[index].aepIndex].payMoney || (item.isSignTtCoupon === 1 ? item.ttCouponPayAmount : 0) || equityListMap.serviceEquityList[index].payMoney}}" >
                            <!-- 支付金额类型为 通行权益金时，文案为“免费” -->
                            <text wx:if="{{item.shopProductId === citicBankshopProductId || item.shopProductId === citicBankShopshopProductId || item.shopProductId === wellBankShopProductId || item.pledgeType === 5}}" style="color: #2A4F44">免费</text>
                            <text wx:else>￥{{tools.parseNum(item.pledgePrice + (equityListMap.addEquityList[index].aepIndex !== -1 ? equityListMap.addEquityList[index].subData[equityListMap.addEquityList[index].aepIndex].payMoney : 0) + equityListMap.serviceEquityList[index].payMoney  + (item.isSignTtCoupon === 1 ? item.ttCouponPayAmount : 0))/100}}</text>
                        </span>
                        <!-- 空发套餐并且设备免费时，隐藏金额 -->
                        <span wx:else style="color: #0f0">{{item.productType === 6 ? '' : '免费'}}</span>
                    </view>
                </view>
                <view class="subTitle">{{tools.limitNumber(item.fullName,15)}}</view>
                <view class="titleExplain" wx:if="{{item.marketingTagType === 2 && item.marketingTag}}">
                    <span class="planSpan">{{item.marketingTag}}</span>
                </view>
                <view class="imgExplain" wx:if="{{item.marketingTagType === 1 && item.marketingTag}}">
                    <image src="{{item.marketingTag}}" mode="widthFix"></image>
                </view>
                <!-- 套餐描述 取后台配置展示，若无配置则不展示 -->
                <view class="description" wx:if="{{item.descriptionList && item.descriptionList.length > 0}}">
                    <view>
                        <view class="descriptionModule" wx:for="{{item.descriptionList}}" wx:for-item="itemBase" wx:key="index1">
                            <view class="title">{{itemBase.value}}</view>
                        </view>
                    </view>
                </view>
                <!-- 套餐附加权益信息显示 -->
                <view class="addEquityInfo">
                    <!-- 设备信息（新旧设备对比） -->
                    <view class="utilModlue" wx:if="{{item.etcCardId === 2 && item.isShowDevice === 1}}" >
                        <view class="name">{{'第五代设备信息'}}</view>
                        <view class="detail" data-type="1" data-index="{{index}}" catchtap="popDetail">详情</view>
                    </view>
                    <!-- 默认权益包（加赠）serviceFeeSendType: 综合服务费发放类型: 1.综合服务费券额，2.权益包 -->
                    <view class="utilModlue" wx:if="{{tools.dataLen(item.rightsPackageId) || item.serviceFeeSendType === 2}}">
                        <view class="name">
                            <text wx:if="{{equityListMap.serviceEquityList[index].packageName}}">{{tools.limitNumber(equityListMap.serviceEquityList[index].packageName + '+' + equityListMap.defaultEquityList[index].subData[0].packageName,20)}}</text>
                            <text wx:else>{{tools.limitNumber(equityListMap.defaultEquityList[index].subData[0].packageName,20)}}</text>
                        </view>
                        <view class="detail" data-type="2" data-index="{{index}}" catchtap="popDetail">详情</view>
                    </view>
                    <!-- （券额/权益包）权益商城 -->
                    <view class="utilModlue" wx:if="{{item.pledgeType === 4 || item.serviceFeeSendType === 1}}">
                        <view class="name">
                            <text wx:if="{{item.couponAmount > 0}}">赠送{{item.couponAmount / 100}}元商城券额</text>
                            <text wx:if="{{item.serviceFeeSendType === 1}}">{{item.couponAmount > 0 ? '+': '赠送'}}{{item.serviceFeeAmount / 100}}元/{{item.serviceFeeAmountSendRule === 1 ? '月' : item.serviceFeeAmountSendRule === 2 ? '季度' : '年'}}{{item.couponAmount > 0 ? tools.limitNumber('综合商城券额',6) : '综合商城券额'}}</text>
                        </view>
                        <view class="detail" data-type="3" data-index="{{index}}" catchtap="popDetail">详情</view>
                    </view>
                    <!-- 通通券会员 -->
                    <view class="utilModlue" wx:if="{{item.isSignTtCoupon}}">
                        <view class="name">{{'ETC+通通券联名会员'}}</view>
                        <view class="detail" data-type="4" data-index="{{index}}" catchtap="popDetail">详情</view>
                    </view>
                </view>
            </view>
            <!-- 增值业务 展示的套餐下半部分 如果又权益和签约通通券则展示-->
            <view class="lowerpart" wx:if="{{item.productRecommend || item.detail }}">
                <view class="titleDetails">
                    <!-- <view class="titles" wx:if="{{item.shopProductId === citicBankshopProductId || item.shopProductId === citicBankShopshopProductId}}">
                        <view class="iconfont greenIcon"></view>
                        <view class="text">中信信用卡套餐办理说明</view>
                    </view>
                    <view class="titles" wx:if="{{item.shopProductId === wellBankShopProductId}}">
                        <view class="iconfont greenIcon"></view>
                        <view class="text">平安信用卡套餐办理说明</view>
                    </view>
                    <view class="titles" wx:if="{{item.pledgeType === 5 && !tools.dataLen(item.rightsPackageIds) && item.etcCardId !== 2 && !(item.shopProductId === citicBankshopProductId || item.shopProductId === citicBankShopshopProductId)}}">
                        <view class="iconfont greenIcon"></view>
                        <view class="text">通行权益金套餐说明</view>
                    </view> -->
                    <view class="titles" wx:if="{{item.productRecommend}}">
                        <view class="iconfont icon"></view>
                        <view class="text">{{tools.limitNumber(item.productRecommend,17)}}</view>
                    </view>
                    <view class="details" catchtap="btnOpenOrOff" data-index="{{[index,isCloseUpperPart,activeIndex]}}">
                        {{ index === activeIndex ? isCloseUpperPart1 ? '收起' : '详情' : isCloseUpperPart2 && index === isCloseUpperPart ? '收起' : '详情'}}
                    </view>
                </view>
                <!-- 套餐 详情展示模块 -->
                <view class="detailsInfo" wx:if="{{index === activeIndex ? isCloseUpperPart1 : isCloseUpperPart2 && index === isCloseUpperPart }}">
                    <rich-text nodes="{{item.detail}}"></rich-text>

                    <!-- <view wx:if="{{item.shopProductId === citicBankshopProductId || item.shopProductId === citicBankShopshopProductId}}" class="isSignTtCoupon">
                        <view class="cict">1、 中信银行信用卡活动，非持卡人可支付保证金后申请中信银行信用卡指定卡板</view>
                        <view class="cict">2、 成功办理中信银行信用卡的新客户即退还全额保证金，信用卡申请不通过，可取消订单退还保证金</view>
                    </view>
                    <view wx:if="{{item.shopProductId === wellBankShopProductId}}" class="isSignTtCoupon">
                        <view class="cict">1、平安银行信用卡活动，非持卡人可支付保证金后申请平安银行信用卡指定卡板</view>
                        <view class="cict">2、成功办理平安银行信用卡的新客户即退还全额保证金，信用卡申请不通过，可取消订单退还保证金</view>
                    </view>
                    <view class="isSignTtCoupon" wx:if="{{item.pledgeType === 5 && !(item.shopProductId === citicBankshopProductId || item.shopProductId === citicBankShopshopProductId)}}">
                        <view class="cict">1、通行权益金可用于抵扣通行费，即微信代扣失败时，会代扣权益金进行垫付，后续微信扣费成功即可奖励通行权益金</view>
                        <view class="cict">2、通行权益金须大于100元，才可用于通行费抵扣</view>
                        <view class="cict">3、激活后通行满36个月奖励账户权益金同等余额的消费金（可提现、可抵扣通行费等）</view>
                    </view> -->
                </view>
            </view>
        </view>
    </view>
    <!-- 占位 -->
    <view class="split {{ isFade ? (activeIndex > tools.dataLen(listOfPackages)-3? 'bigSplit' : '') : 'littleSplit'}} {{tools.dataLen(listOfPackages[activeIndex].rightsPackageIds) ? 'isRPI' : ''}}" ></view>
    <!-- 加购的权益包 -->
    <view class="addEquityPackage" wx:if="{{tools.dataLen(listOfPackages[activeIndex].rightsPackageIds) && isLoaded && true}}" data-type="5" data-index='{{activeIndex}}' catchtap="popDetail">
        <view class="imgOrName">
            <view class="img"><image class="image" src="{{'https://file.cyzl.com/g001/M02/ED/17/oYYBAGStEiOAZAb0AAAV9IqXKBM565.png'}}" mode="widthFix" /></view>
            <text wx:for="{{equityListMap.addEquityList[activeIndex].subData}}" wx:for-item="item2" wx:key="index">{{item2.packageName}}{{index === tools.dataLen(equityListMap.addEquityList[activeIndex].subData) - 1 ? '' : '+'}}</text>
        </view>
        <view class="iconfont icon4"></view>
    </view>
<!-- 支付和协议说明 模块 -->
    <view class="payAndAgreement {{isFade ? 'fadeIn' : 'fadeOut'}}" wx:if="{{isLoaded}}">
        <view class="agreementConfirm" bindtap="onClickAgreementHandle">
            <view class="confirm iconfont {{getAgreement ? 'tick' : ''}}" catchtap="onClickAgreementHandle"></view>
            <view class="agreement">
                当您勾选同意并选购套餐时，即代表您已阅读、理解并接受
                <text class="agreementColor" catchtap="onClickGoTTQAgreement1" wx:if="{{listOfPackages[choiceIndex].isSignTtCoupon === 1}}">通通券会员服务协议、</text>
                <text class="agreementColor" catchtap="onClickGoAgreementHandle">ETC用户办理协议、</text>
                <text class="agreementColor" catchtap="onClickGoQianTongAgreement" wx:if="{{listOfPackages[choiceIndex].etcCardId === 1}}">黔通卡ETC用户协议、</text>
                <text class="agreementColor" catchtap="onClickGoPrivacyHandle">用户隐私协议</text>
                里的相关规定 ; 若您不认可、不接受上述内容。请勿支付并退出该页面即可。
            </view>
        </view>
        <!-- 按钮设置 -->
        <!-- 通通券 -->
        <view class="ttCounpon" wx:if="{{ isSalesmanOrder && choiceIndex !== -1 && isPay && listOfPackages.length && listOfPackages[choiceIndex].isSignTtCoupon === 1 }}">
            <!-- 通用券套餐已支付或无需支付 -->
            <button class="btn {{getAgreement ? 'payColor' : ''}}" catchtap="handleSign" wx:if="{{tools.parseNum(listOfPackages[choiceIndex].ttCouponPayAmount) > 0}}">
                {{contractStatus === 1 ? '开通连续包月服务' : '签约代扣通行费'}}
            </button>
            <!-- 通通券金额 为0 时 执行微信签约 -->
            <button class="btn {{getAgreement ? 'payColor' : ''}}" catchtap="toWeChatSign" wx:else>
                去签约
            </button>
        </view>
        <!-- 签约、支付、下一步 -->
        <view class="paySign" wx:else>
            <view class="moneyPay {{isFade ? 'confirmPackage' : ''}}" wx:if="{{choiceIndex !== -1 && (listOfPackages[activeIndex].pledgePrice || (equityListMap.addEquityList[activeIndex].aepIndex !== -1 ? equityListMap.addEquityList[activeIndex].subData[equityListMap.addEquityList[activeIndex].aepIndex].payMoney : 0) || equityListMap.serviceEquityList[activeIndex].payMoney)}}">
                <view class="money" wx:if="{{isFade}}">
                    ￥<span class="mpneySpan">{{activeIndex !== -1 ? tools.parseNum((listOfPackages[activeIndex].pledgePrice + equityListMap.serviceEquityList[activeIndex].payMoney + (equityListMap.addEquityList[activeIndex].aepIndex !== -1 ? equityListMap.addEquityList[activeIndex].subData[equityListMap.addEquityList[activeIndex].aepIndex].payMoney : 0))/100) : tools.parseNum(listOfPackages[activeIndex].pledgePrice/100)}}
                </span>
                </view>
                <view class="pay {{ !isFade ? 'payWidth' : ''}} {{getAgreement ? 'payColor' : ''}} bail" data-isconfirm="{{getAgreement}}" wx:if="{{listOfPackages[activeIndex].pledgeType === 5 || citicBank}}" catchtap="next">
                    <view wx:if="{{citicBank}}">
                        <view class="titlea">支付保证金</view>
                        <view class="subTitlea">ETC激活后补贴生效，手动确认返还保证金</view></view>
                    <view wx:else>支付通行权益金</view>
                </view>
                <view class="pay {{ !isFade ? 'payWidth' : ''}} {{getAgreement ? 'payColor' : ''}}" data-isconfirm="{{getAgreement}}" wx:else catchtap="next">{{'去支付'}}</view>
            </view>
            <view class="nextSign" wx:else>
                <button class="btns {{choiceIndex === -1 || getAgreement ? 'payColor' : ''}}" catchtap="next" >
                    {{isSalesmanOrder ? '去签约' : emptyHairOrder ? '确认套餐' :'下一步'}}
                </button>
            </view>
        </view>
    </view>
    <popTipComp id="popTipComp" bind:confirmHandle="confirmHandle"></popTipComp>
    <!-- 自定义出入方向的弹窗 -->
    <customDirectionPopup id="cdPopup" bind:cDPopup="cDPopup"/>
</view>
