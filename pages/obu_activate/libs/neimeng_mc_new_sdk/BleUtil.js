const dataUtil=require('./DataUtil.js');module['exports']={'connectAndInit':connectDevice,'disConnect':disconnectDevice,'sendAndReceive':transCmd,'sendA5Command':sendA5Command,'openOrCloseAerial':openOrCloseAerial};const codeEnum={'successCode':0x3e8,'failureCode':0x1,'stopScanFailure':0x2,'creatConnectionFailure':0x3,'getServiceFailure':0x4,'noTargetServiceId':0x5,'getCharacteristicsFailure':0x6,'noTargetCharacteristic':0x7,'monitorNotificationFailure':0x8,'authResponseFailure':0x9,'initResponseFailure':0xa,'initDeviceFailure':0xb,'dataFrameTransboundary':0xc,'notPassBccCheck':0xd,'sendDataFailure':0xe,'paraError':0xf,'timeout':0x64};const FUNCTION='function';const serviceUUID='0000FEE7-0000-1000-8000-00805F9B34FB';const writeUUID='0000FEC7-0000-1000-8000-00805F9B34FB';const readUUID='0000FEC8-0000-1000-8000-00805F9B34FB';const connectTime=(0x6cb11^0x6cb05)*(0xe886a^0xe8b82);const startA2Time=0x6f96e^0x6f99e;const waitA2ResponseTime=0xcdd51^0xcdeb9;var haveFoundDevice=new Array();var connectDeviceId;var connectCallback;var connectTimer;var transTimer;var frame='';var frameLen=0x60c6a^0x60c6a;var frames=new Array();var framesLen=0xb1b16^0xb1b16;var dataHandlerCallback;var sendBufferArray=new Array();var cmds=new Array();var sendIndex;var resendCount=0x78457^0x78454;function toObject(_0x28a52e,_0x14cb32,_0x47d887){return{'code':_0x28a52e,'data':_0x14cb32,'msg':_0x47d887};}function startConnectBle(){wx['createBLEConnection']({'deviceId':connectDeviceId,'success':function(_0x538f58){startGetAndCheckService();},'fail':function(_0xe7ed8b){if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0xc0a6c^0xc05cc,undefined,_0xe7ed8b['errMsg']));}});}function startGetAndCheckService(){wx['getBLEDeviceServices']({'deviceId':connectDeviceId,'success':function(_0x3c8ae8){let _0xd87416=![];for(let _0x4658e1=0x2826a^0x2826a;_0x4658e1<_0x3c8ae8['services']['length'];_0x4658e1++){let _0x43d3b9=_0x3c8ae8['services'][_0x4658e1]['uuid'];if(_0x43d3b9==serviceUUID){_0xd87416=!![];break;}}if(_0xd87416==!![]){startGetAndCheckCharacterisitc();}else{if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(codeEnum['noTargetServiceId'],undefined,'noTargetServiceId'));}},'fail':function(_0x22023c){if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0xeb3dd^0xebc7d,undefined,_0x22023c['errMsg']));}});}function startGetAndCheckCharacterisitc(){wx['getBLEDeviceCharacteristics']({'deviceId':connectDeviceId,'serviceId':serviceUUID,'success':function(_0x20a935){let _0x58d4f2=![];let _0x1ab261=![];for(let _0x9f29e8=0x3ed09^0x3ed09;_0x9f29e8<_0x20a935['characteristics']['length'];_0x9f29e8++){let _0xf2af4c=_0x20a935['characteristics'][_0x9f29e8]['uuid'];if(_0xf2af4c==readUUID){_0x58d4f2=!![];}else if(_0xf2af4c==writeUUID){_0x1ab261=!![];}if(_0x58d4f2==!![]&&_0x1ab261==!![]){break;}}if(_0x58d4f2==!![]&&_0x1ab261==!![]){monitorNotification();}else{if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0xfa0,undefined,'noTargetCharacteristic'));}},'fail':function(_0x555ee0){if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0x627a9^0x62809,undefined,_0x555ee0['errMsg']));}});}function monitorNotification(){wx['notifyBLECharacteristicValueChange']({'deviceId':connectDeviceId,'serviceId':serviceUUID,'characteristicId':readUUID,'state':!![],'success':function(_0x5f2180){if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}setTimeout(()=>{typeof connectCallback['success']==FUNCTION&&connectCallback['success'](toObject(codeEnum['successCode'],undefined,'连接成功,握手成功'));},0xaa3fc^0xaa014);},'fail':function(){if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0xfa0,undefined,'monitorNotificationFailure'));}});wx['onBLECharacteristicValueChange'](function(_0x170e47){if(_0x170e47['deviceId']=connectDeviceId&&_0x170e47['serviceId']==serviceUUID&&_0x170e47['characteristicId']==readUUID){analyticData(_0x170e47['value']);}});}var sendDataCount=0x1;function analyticData(_0x2423fe){let _0x34a290=dataUtil['bufferArrayToHexString'](_0x2423fe);if(_0x34a290['length']==0x28&&_0x34a290['slice'](0x0,0x4)=='fe01'){console['log']('开始接收：');sendDataCount=0x0;}sendDataCount++;console['log']('第',sendDataCount,'包数据：',_0x34a290);if(frame['length']==0x0){frameLen=parseInt(_0x34a290['slice'](0x2cd16^0x2cd12,0x8),0x3aa6a^0x3aa7a)*0x2;}frame+=_0x34a290;if(frame['slice'](0x0,0x4)!='fe01'){frame='';frameLen=0x0;}else if(frame['length']>frameLen){frame='';frameLen=0x44f01^0x44f01;typeof dataHandlerCallback==FUNCTION&&dataHandlerCallback(toObject(codeEnum['dataFrameTransboundary'],'','数据长度越界'));}else if(frame['length']==frameLen){let _0x2a18bc=frame['slice'](0x61a95^0x61a9d,0xc);if(_0x2a18bc==='2712'){let _0x4b7fb7=frame['slice'](0x10);let _0x345e9e=_0x4b7fb7['slice'](0x744a8^0x744a0,-0x6);frame='';frameLen=0x0;if(frames['length']==(0x88982^0x88982)){let _0x368299=parseInt(_0x345e9e['slice'](0x4,0x6),0xefbbf^0xefbaf);framesLen=_0x368299-0x80+0x1;}frames['push'](_0x345e9e);if(frames['length']==framesLen){let _0x1856cb=!![];for(let _0x3b705f=0x0;_0x3b705f<frames['length'];_0x3b705f++){let _0x533e82=frames[_0x3b705f];let _0x3ceb24=0xad136^0xad136;for(let _0x558020=0xf26c8^0xf26c9;_0x558020<parseInt(_0x533e82['length']/0x2)-(0x3d5c1^0x3d5c0);_0x558020++){let _0x1ce5e2=parseInt(_0x533e82['slice'](_0x558020*(0xbfdd8^0xbfdda),(_0x558020+0x1)*0x2),0x10);_0x3ceb24^=_0x1ce5e2;}if(_0x3ceb24!=parseInt(_0x533e82['slice'](-0x2),0xb9302^0xb9312)){_0x1856cb=![];break;}}if(_0x1856cb==![]){frames=new Array();framesLen=0x0;typeof dataHandlerCallback==FUNCTION&&dataHandlerCallback(toObject(codeEnum['notPassBccCheck'],'','bcc校验不通过'));}else{let _0x44232a='';for(let _0x1fd8a7=0x0;_0x1fd8a7<frames['length'];_0x1fd8a7++){let _0x45102b=frames[_0x1fd8a7];_0x44232a+=_0x45102b['slice'](0x8,-(0xed630^0xed632));}frames=new Array();framesLen=0x0;typeof dataHandlerCallback==FUNCTION&&dataHandlerCallback(toObject(codeEnum['successCode'],_0x44232a,'成功'));}}}else{console['log']('提示数据');frame='';frameLen=0x2dacb^0x2dacb;}}}function connectDevice(_0x450024,_0xfac96b,_0xbb6584){connectDeviceId=_0x450024['deviceId'];connectCallback=_0xfac96b;if(typeof connectTimer!=undefined){clearTimeout(connectTimer);}connectTimer=setTimeout(()=>{typeof connectCallback['fail']==FUNCTION&&connectCallback['fail'](toObject(0xac57c^0xac2ae,undefined,'连接超时'));},_0xbb6584);startConnectBle();}function disconnectDevice(_0x457c8f){const _0x4a1efc=String(connectDeviceId);wx['closeBLEConnection']({'deviceId':_0x4a1efc,'success'(_0x1ee229){console['log'](_0x1ee229);typeof _0x457c8f['success']==FUNCTION&&_0x457c8f['success'](toObject(codeEnum['successCode'],_0x1ee229,'断开连接成功'));},'fail'(_0x3a2347){console['log'](_0x3a2347);typeof _0x457c8f['fail']==FUNCTION&&_0x457c8f['fail'](toObject(0xabb67^0xab4c7,_0x3a2347,'断开连接失败'));}});}function sendAndReceive(_0x1188cc,_0x424460,_0x1c18ee,_0x591582){let _0x3921cf=![];let _0x1cf69d=setTimeout(()=>{typeof _0x1c18ee['fail']==FUNCTION&&_0x1c18ee['fail'](toObject(0x6b7ad^0x6b07f,undefined,_0x1188cc==0x0?'发送ICC指令超时':'发送esam指令超时'));},_0x591582);transCmd(_0x1188cc,_0x424460,{'success':_0x307e63=>{clearTimeout(_0x1cf69d);typeof _0x1c18ee['success']==FUNCTION&&_0x1c18ee['success'](_0x307e63);},'fail':_0x5aea8e=>{if(_0x5aea8e['code']==(0xe40e4^0xe4734)&&_0x3921cf==![]){console['log']('开始重发');_0x3921cf=!![];transCmd(_0x1188cc,_0x424460,{'success':_0x3fa206=>{clearTimeout(_0x1cf69d);typeof _0x1c18ee['success']==FUNCTION&&_0x1c18ee['success'](_0x3fa206);},'fail':_0x531006=>{clearTimeout(_0x1cf69d);typeof _0x1c18ee['fail']==FUNCTION&&_0x1c18ee['fail'](_0x531006);}},0xdbe24^0xdb9f4);}else{clearTimeout(_0x1cf69d);typeof _0x1c18ee['fail']==FUNCTION&&_0x1c18ee['fail'](_0x5aea8e);}}},0x7d0);}function transCmd(_0xa048b8,_0xb9566c,_0x255dfb,_0x283995){if(_0xa048b8!=(0xee953^0xee953)&&_0xa048b8!=(0x86a46^0x86a47)&&_0xa048b8!=0x2){typeof _0x255dfb['fail']==FUNCTION&&_0x255dfb['fail'](toObject(0xfa0,undefined,'type\x20错误'));return;}if(typeof transTimer!=undefined){clearTimeout(transTimer);}transTimer=setTimeout(()=>{typeof _0x255dfb['fail']==FUNCTION&&_0x255dfb['fail'](toObject(0x876ec^0x8713e,undefined,_0xa048b8==(0x93d23^0x93d23)?'发送ICC指令超时':'发送esam指令超时'));},_0x283995);cmds=_0xb9566c['slice']();var _0x5eb2a5=new Array();var _0x511851;var _0x48eb8b;for(var _0x4c7c6d=0x0;_0x4c7c6d<_0xb9566c['length'];_0x4c7c6d++){if(_0x4c7c6d==(0x3460a^0x3460a)){_0x511851=cmds['shift']();_0x48eb8b=promise(_0x511851,_0xa048b8);}_0x48eb8b=_0x48eb8b['then'](_0x4afa96=>{if(typeof transTimer!=undefined){clearTimeout(transTimer);}if(_0x4afa96===undefined){return;}_0x5eb2a5['push'](_0x4afa96);if(cmds['length']>(0xed32e^0xed32e)){transTimer=setTimeout(()=>{typeof _0x255dfb['fail']==FUNCTION&&_0x255dfb['fail'](toObject(0xa5f06^0xa58d4,undefined,_0xa048b8==(0xbe627^0xbe627)?'发送ICC指令超时':'发送esam指令超时'));},_0x283995);_0x511851=cmds['shift']();return promise(_0x511851,_0xa048b8);}typeof _0x255dfb['success']==FUNCTION&&_0x255dfb['success'](toObject(codeEnum['successCode'],_0x5eb2a5,_0xa048b8==(0xd0c5c^0xd0c5c)?'发送ICC指令成功':'发送esam指令成功'));},(_0x9a68d6,_0x2103ac)=>{if(_0x9a68d6!=undefined){if(typeof transTimer!=undefined){clearTimeout(transTimer);}typeof _0x255dfb['fail']==FUNCTION&&_0x255dfb['fail'](toObject(0xfa0,_0x5eb2a5,_0x511851+_0x9a68d6));}});}}function promise(_0xb5df02,_0x338d7a){return new Promise((_0x40bafe,_0x46482b)=>{if(_0x338d7a===0x0){var _0x5b7439=dataUtil['makeA3SendData']('00',dataUtil['makeTLV']([_0xb5df02]));}else if(_0x338d7a==0x1){var _0x5b7439=dataUtil['makeA7SendData']('00',dataUtil['makeTLV']([_0xb5df02]));}else{var _0x5b7439=dataUtil['makeA8SendData']('00',dataUtil['makeTLV']([_0xb5df02]));}sendDataToDevice(_0x5b7439,_0x21e74d=>{if(_0x21e74d['code']===codeEnum['successCode']){if(_0x21e74d['data']['slice'](0xab6d5^0xab6d7,0x4)==='00'||_0x21e74d['data']['slice'](0x2,0x4)==='cf'){let _0x23c5f9=_0x21e74d['data']['slice'](0xa);let _0x57874b=dataUtil['resolveTLV'](_0x21e74d['data']['slice'](0xe16cd^0xe16c7));if(_0x57874b['length']==(0x2ed70^0x2ed71)){_0x40bafe(_0x57874b[0xe3938^0xe3938]);}else{_0x46482b('数据返回错误');}}else{let _0x550240=_0x21e74d['data']['slice'](0xa);let _0x2eb31b=dataUtil['resolveTLV'](_0x21e74d['data']['slice'](0x45f14^0x45f1e));_0x46482b('错误码:'+_0x2eb31b[_0x2eb31b['length']-0x1]['slice'](-0x4));}}else{_0x46482b(_0x21e74d['msg']);}});});}function sendDataToDevice(_0x474be2,_0x334f82){dataHandlerCallback=_0x334f82;sendBufferArray=new Array()['concat'](_0x474be2);sendIndex=0x6f772^0x6f772;frame='';frameLen=0xb8e55^0xb8e55;frames=new Array();framesLen=0x0;console['log']('开始发送:');runningSendData();}function runningSendData(){let _0x405bef=sendBufferArray[sendIndex];let _0x1e8975=dataUtil['bufferArrayToHexString'](_0x405bef);console['log']('第',sendIndex+0x1,'包数据：',_0x1e8975);wx['writeBLECharacteristicValue']({'deviceId':connectDeviceId,'serviceId':serviceUUID,'characteristicId':writeUUID,'value':_0x405bef,'success':function(_0x539451){sendIndex++;resendCount=0x3;if(sendIndex<sendBufferArray['length']){runningSendData();}},'fail':function(_0x38890b){if(resendCount>(0x54aa1^0x54aa1)){resendCount--;setTimeout(()=>{console['log']('第'+(0x3-resendCount)+'次重发');runningSendData();},0xc8);}else{typeof dataHandlerCallback==FUNCTION&&dataHandlerCallback(toObject(codeEnum['sendDataFailure'],'','发送数据失败:'+_0x38890b['errMsg']));}}});}function sendA5Command(_0x519300,_0x1045b6,_0x1e287a){var _0x5e712b=setTimeout(()=>{typeof _0x1045b6['fail']==FUNCTION&&_0x1045b6['fail'](toObject(0x7d2,undefined,'发送蓝牙指令超时'));},_0x1e287a);var _0xdc9210=dataUtil['makeA5SendData'](_0x519300);sendDataToDevice(_0xdc9210,_0xb215d7=>{if(_0x5e712b!=undefined){clearTimeout(_0x5e712b);}if(_0xb215d7['code']===codeEnum['successCode']){if(_0xb215d7['data']['slice'](0x0,0x2)=='b5'&&_0xb215d7['data']['slice'](0x2,0x4)=='00'){let _0x1d5593=parseInt(_0xb215d7['data']['slice'](0x4,0x6),0x10);typeof _0x1045b6['success']==FUNCTION&&_0x1045b6['success'](toObject(codeEnum['successCode'],_0xb215d7['data']['slice'](0x6,0x6+_0x1d5593*(0xe739e^0xe739c)),'成功'));}else{typeof _0x1045b6['fail']==FUNCTION&&_0x1045b6['fail'](toObject(0x7be16^0x7b1b6,_0xb215d7['data'],'发送蓝牙指令返回数据异常'));}}else{typeof _0x1045b6['fail']==FUNCTION&&_0x1045b6['fail'](toObject(0x8449e^0x84b3e,undefined,'发送数据失败'));}});}function openOrCloseAerial(_0x2c5e7e,_0x3e5802,_0x332527,_0x2165d0){if(_0x2c5e7e!=0x1&&_0x2c5e7e!=(0x7eb68^0x7eb6a)&&_0x2c5e7e!=(0x6b4ee^0x6b4ed)&&_0x2c5e7e!=0x4){typeof _0x332527['fail']==FUNCTION&&_0x332527['fail'](toObject(0xfa0,undefined,'无效参数'));}else{var _0x330f43=setTimeout(()=>{typeof _0x332527['fail']==FUNCTION&&_0x332527['fail'](toObject(0xb3dad^0xb3a7f,undefined,'打开/关闭5.8G指令超时'));},_0x2165d0);let _0x2e7419=_0x3e5802;if(_0x3e5802<(0xbf5b2^0xbf5b2)){_0x2e7419=0x0;}if(_0x3e5802>0x12c){_0x2e7419=0xd69b1^0xd689d;}let _0x1c493b='C7'+parseInt(_0x2c5e7e)['toString'](0x10)['padStart'](0x2,'0');if(_0x2c5e7e==0x2){_0x1c493b+=parseInt(_0x2e7419)['toString'](0x9e48d^0x9e49d)['padStart'](0x4,'0');}var _0x56bdfd=dataUtil['makeA5SendData'](_0x1c493b);sendDataToDevice(_0x56bdfd,_0x3efe36=>{if(_0x330f43!=undefined){clearTimeout(_0x330f43);}if(_0x3efe36['code']===codeEnum['successCode']){if(_0x3efe36['data']['slice'](0xc17a1^0xc17a1,0x2)=='b5'&&_0x3efe36['data']['slice'](0x2,0x4)=='00'){let _0x1416d9=parseInt(_0x3efe36['data']['slice'](0x4,0x6),0x10);typeof _0x332527['success']==FUNCTION&&_0x332527['success'](toObject(codeEnum['successCode'],_0x3efe36['data']['slice'](0x6,(0x8f2d4^0x8f2d2)+_0x1416d9*(0x8a03f^0x8a03d)),'成功'));}else{typeof _0x332527['fail']==FUNCTION&&_0x332527['fail'](toObject(0xfa0,_0x3efe36['data'],'发送蓝牙指令返回数据异常'));}}else{typeof _0x332527['fail']==FUNCTION&&_0x332527['fail'](toObject(0xaae5e^0xaa1fe,undefined,'打开/关闭5.8G失败'));}});}}