"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_wjUtils=require("./wjUtils.js"),_wjUtils2=_interopRequireDefault(_wjUtils);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var timeID,ListenFlag=void 0,DataListenerCallBack=void 0,connectedDeviceId="",foundDevices=[],TAG_FUNCTION="function",services="0000FEE7-0000-1000-8000-00805F9B34FB",notifyServiceId="0000FEC8-0000-1000-8000-00805F9B34FB",writeServiceId="0000FEC7-0000-1000-8000-00805F9B34FB";function reallyScanConnect(s){var e={};wx.closeBluetoothAdapter(),_wjUtils2.default.showLog("/***********Runing :: Do reallyScanConnect() begin *************/"),foundDevices=[],wx.openBluetoothAdapter({success:function(e){wx.startBluetoothDevicesDiscovery({services:[],success:function(e){wx.onBluetoothDeviceFound(function(e){for(var i=0;i<e.devices.length;i++){for(var t=!1,c=0;c<foundDevices.length;c++)if(e.devices[i].deviceId==foundDevices[c].deviceId){t=!0;break}if(_wjUtils2.default.showLog("connectedDeviceName",e.devices[i].name),0==t){foundDevices.push(e.devices[i]);var n=e.devices[i].name;if(-1!=n.toUpperCase().indexOf("WJ")||-1!=n.toUpperCase().indexOf("WanJi")||-1!=n.toUpperCase().indexOf("HN")||-1!=n.toUpperCase().indexOf("SD")||-1!=n.indexOf("NM")){connectedDeviceId=e.devices[i].deviceId,_wjUtils2.default.showLog("connectedDeviceId",e.devices);var o={};o.device_name=n,o.device_id=connectedDeviceId,wx.stopBluetoothDevicesDiscovery({success:function(e){null!=timeID&&(clearTimeout(timeID),timeID=null),_wjUtils2.default.showLog("停止扫描，开始连接"),reallyConnect(o,function(e){e.serviceInfo=connectedDeviceId,(void 0===s?"undefined":_typeof(s))==TAG_FUNCTION&&s(e)})},fail:function(e){_wjUtils2.default.showError("stopBluetoothDevicesDiscovery fail",e)}});break}}}})},fail:function(e){_wjUtils2.default.showError("startBluetoothDevicesDiscovery fail",e)}})},fail:function(e){_wjUtils2.default.showError("openBluetoothAdapter fail",e)}}),wx.onBLEConnectionStateChange(function(e){0==e.connected&&(wx.closeBLEConnection({deviceId:e.deviceId,success:function(e){_wjUtils2.default.showLog("closeBLEConnection:",e)}}),wx.closeBluetoothAdapter({success:function(e){_wjUtils2.default.showLog("closeBluetoothAdapter",e)}})),console.error("device "+e.deviceId+" state has changed, connected: "+e.connected)}),timeID=setTimeout(function(){wx.stopBluetoothDevicesDiscovery(),_wjUtils2.default.showError("scan timeout fail"),e.serviceCode=-1,e.serviceInfo="scan timeout fail!",(void 0===s?"undefined":_typeof(s))==TAG_FUNCTION&&s(e)},5e3)}function reallyConnect(e,i){_wjUtils2.default.showLog("V1.0.0,date:2019.10.17,");var t={},c=e.device_name;_wjUtils2.default.showLog("name",c),-1==c.toUpperCase().indexOf("WJ")&&-1==c.toUpperCase().indexOf("WanJi")&&-1==c.toUpperCase().indexOf("HN")&&-1==c.toUpperCase().indexOf("SD")&&-1==c.indexOf("NM")||(connectedDeviceId=e.device_id,wx.createBLEConnection({deviceId:connectedDeviceId,success:function(e){_wjUtils2.default.showLog("已连接,开始使能服务",connectedDeviceId),_enableService(function(e){0==e.serviceCode?(_wjUtils2.default.showLog("已连接,并使能成功"),(t=e).serviceInfo=connectedDeviceId):(t=e).serviceInfo="连接成功，但服务使能失败!",(void 0===i?"undefined":_typeof(i))==TAG_FUNCTION&&i(t)})},fail:function(e){_wjUtils2.default.showError("createBLEConnection fail",e)}}))}function _enableService(n){var o={};wx.getBLEDeviceServices({deviceId:connectedDeviceId,success:function(e){for(var i=0;i<e.services.length;i++){var t=e.services[i].uuid;t==services&&wx.getBLEDeviceCharacteristics({deviceId:connectedDeviceId,serviceId:t,success:function(e){for(var i=0,t=0;t<e.characteristics.length;t++){var c=e.characteristics[t].uuid;c==notifyServiceId?i++:c==writeServiceId&&i++}i<2?(o.serviceCode=-1,o.serviceInfo="getBLEDeviceCharacteristics temp<2!",(void 0===n?"undefined":_typeof(n))==TAG_FUNCTION&&n(o)):wx.notifyBLECharacteristicValueChange({deviceId:connectedDeviceId,serviceId:services,characteristicId:notifyServiceId,state:!0,success:function(e){_onBLECharacteristicValueChange(),o.serviceCode=0,o.serviceInfo="enable success!",(void 0===n?"undefined":_typeof(n))==TAG_FUNCTION&&n(o)},fail:function(){o.serviceCode=-2,o.serviceInfo="notifyBLECharacteristicValueChange fail!",(void 0===n?"undefined":_typeof(n))==TAG_FUNCTION&&n(o)}})},fail:function(){o.serviceCode=-3,o.serviceInfo="getBLEDeviceCharacteristics fail!",(void 0===n?"undefined":_typeof(n))==TAG_FUNCTION&&n(o)}})}},fail:function(){o.serviceCode=-4,o.serviceInfo="getBLEDeviceServices fail!",(void 0===n?"undefined":_typeof(n))==TAG_FUNCTION&&n(o)}})}function reallyDisConnect(e,i){var t={};connectedDeviceId=e,wx.closeBLEConnection({deviceId:connectedDeviceId,success:function(e){_wjUtils2.default.showLog("closeBLEConnection:",e)}}),wx.closeBluetoothAdapter({success:function(e){_wjUtils2.default.showLog("closeBluetoothAdapter",e),t.serviceCode=0,t.serviceInfo="断开蓝牙成功!",(void 0===i?"undefined":_typeof(i))==TAG_FUNCTION&&i(t)}})}function _writeBLECharacteristicValue(e,i){var t={};wx.writeBLECharacteristicValue({deviceId:connectedDeviceId,serviceId:services,characteristicId:writeServiceId,value:e,success:function(e){_wjUtils2.default.showLog("writeBLECharacteristicValue success",e.errMsg),t.serviceCode=0,t.serviceInfo=e.errMsg,(void 0===i?"undefined":_typeof(i))==TAG_FUNCTION&&i(t)}})}function _onBLECharacteristicValueChange(){wx.onBLECharacteristicValueChange(function(e){_wjUtils2.default.showLog("有回复"),1==ListenFlag&&(void 0===DataListenerCallBack?"undefined":_typeof(DataListenerCallBack))==TAG_FUNCTION&&DataListenerCallBack(e.value)})}function _SetDataListenerCallBack(e,i){1==e?(ListenFlag=!0,DataListenerCallBack=i):0==e&&(ListenFlag=!1)}module.exports={reallyConnect:reallyConnect,reallyScanConnect:reallyScanConnect,reallyDisConnect:reallyDisConnect,_writeBLECharacteristicValue:_writeBLECharacteristicValue,_SetDataListenerCallBack:_SetDataListenerCallBack};