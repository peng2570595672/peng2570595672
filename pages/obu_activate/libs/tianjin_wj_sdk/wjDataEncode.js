"use strict";var _wjUtils=require("./wjUtils.js"),_wjUtils2=_interopRequireDefault(_wjUtils);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function encode(e,t,a){var r=_wjUtils2.default.getProtocolType(),n=getETCData(e,t,a),s={};return 0==r?s=encode_GB(n):1==r&&(s=encode_WX(n)),s}function getETCData(e,t,a){return""!=e&&""!=a&&("A0"==a||"A3"==a||"A4"==a||"82"==a||"84"==a||"A6"==a)?getCommand(e,t,a):e}function getCommand(e,t,a){var r=e,n=_wjUtils2.default.getDATA_TYPE(),s=e.length/2,i=new ArrayBuffer(10),d=new DataView(i);if(0==n&&""!=t)l=256<s?(d.setInt8(0,4+s&255),d.setInt8(1,4+s>>8&255),d.setInt8(2,128),d.setInt8(3,130),d.setInt8(4,s>>8&255),d.setInt8(5,255&s),i.slice(0,6)):128<s&&s<=256?(d.setInt8(0,3+s&255),d.setInt8(1,3+s>>8&255),d.setInt8(2,128),d.setInt8(3,129),d.setInt8(4,s),i.slice(0,5)):(d.setInt8(0,2+s&255),d.setInt8(1,2+s>>8&255),d.setInt8(2,128),d.setInt8(3,s),i.slice(0,4)),r=_wjUtils2.default.byteArray2hexStr(l)+r;else if(1==n||""==t){var l;d.setInt8(0,255&s),d.setInt8(1,s>>8&255),l=i.slice(0,2),r=_wjUtils2.default.byteArray2hexStr(l)+r}return a+t+r}function encode_GB(e){var t={},a=_wjUtils2.default.getPagLenMax(),r=parseInt(e.length/2/a);e.length/2%a!=0&&(r+=1);var n=new ArrayBuffer(10);new DataView(n);t.serviceCode=0,t.serviceInfo="encode ok",t.serviceData={},t.serviceData.dataEncode=new Array;for(var s=0;s<r-1;s++)t.serviceData.dataEncode[s]=e.substr(s*a*2,2*a),t.serviceData.dataEncode[s]=getGBFrame(t.serviceData.dataEncode[s],s,r);return t.serviceData.dataEncode[r-1]=e.substring((r-1)*a*2),t.serviceData.dataEncode[r-1]=getGBFrame(t.serviceData.dataEncode[r-1],r-1,r),t}function encode_WX(e){var t={},a=_wjUtils2.default.getPagLenMax(),r=parseInt(e.length/2/a);e.length/2%a!=0&&(r+=1),t.serviceCode=0,t.serviceInfo="encode ok",t.serviceData={},t.serviceData.dataEncode=new Array;var n=0;for(n=0;n<r-1;n++)t.serviceData.dataEncode[n]=e.substr(n*a*2,2*a),t.serviceData.dataEncode[n]=getWXFrame(t.serviceData.dataEncode[n],n,r);return t.serviceData.dataEncode[r-1]=e.substring((r-1)*a*2),t.serviceData.dataEncode[r-1]=getWXFrame(t.serviceData.dataEncode[r-1],r-1,r),t}function getWXFrame(e,t,a){var r=e,n=new ArrayBuffer(10),s=new DataView(n),i="",d="",l=0,c=e.length/2;0==t?s.setInt8(0,128+(a-1-t&255)):s.setInt8(0,a-1-t&255),r="3301"+(i=_wjUtils2.default.byteArray2hexStr(n).substring(0,2))+_wjUtils2.default.byte2hexStr(255&c)+r;for(var u=_wjUtils2.default.hexStr2byteArray(r),o=1;o<u.length;o++)l^=u[o];r+=_wjUtils2.default.byte2hexStr(l);var f=_wjUtils2.default.hexStr2byteArray(r).length;if(127<f){s.setInt8(0,128+(f%128&255)),s.setInt8(1,f/128&255),i=_wjUtils2.default.byteArray2hexStr(n).substring(0,4);var w=f+8+4+3;s.setInt8(0,w>>8&255),s.setInt8(1,255&w),d=_wjUtils2.default.byteArray2hexStr(n).substring(0,4)}else{s.setInt8(0,255&f),i=_wjUtils2.default.byteArray2hexStr(n).substring(0,2);w=f+8+4+2;s.setInt8(0,w>>8&255),s.setInt8(1,255&w),d=_wjUtils2.default.byteArray2hexStr(n).substring(0,4)}return r="FE01"+d+"753100000A0012"+i+r+"1800"}function getGBFrame(e,t,a){var r=e,n=new ArrayBuffer(10),s=new DataView(n),i=0,d=e.length/2;0==t?(s.setInt8(0,128+(a>>8&255)),s.setInt8(1,255&a)):(s.setInt8(0,t+1>>8&255),s.setInt8(1,t+1&255)),s.setInt8(2,255&d),r="50"+_wjUtils2.default.byteArray2hexStr(n).substring(0,6)+r;for(var l=_wjUtils2.default.hexStr2byteArray(r),c=0;c<l.length;c++)i^=l[c];return r+=_wjUtils2.default.byte2hexStr(i)}module.exports={encode:encode};